# QuickCart Docker Compose Configuration
#
# âš ï¸  IMPORTANT: Before running, copy the environment template:
#     cp .env.example.template .env
#     Then edit .env with your actual values!
#
# Required environment variables (must be set in .env):
#   - TELEGRAM_BOT_TOKEN (from @BotFather)
#   - ADMIN_USER_IDS (your Telegram user ID from @userinfobot)
#   - PAKASIR_API_KEY (from pakasir.com)
#   - PAKASIR_PROJECT_SLUG (from pakasir.com)
#   - SECRET_KEY (generate with: python -c "import secrets; print(secrets.token_urlsafe(32))")
#   - ENCRYPTION_KEY (generate with: python -c "import secrets; print(secrets.token_urlsafe(32))")
#
# Quick start:
#   1. cp .env.example.template .env
#   2. Edit .env with your values
#   3. docker compose up -d
#
# See INSTALL.md for complete step-by-step guide
# See README.md for features and documentation

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: quickcart_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: quickcart
      POSTGRES_PASSWORD: quickcart123
      POSTGRES_DB: quickcart
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quickcart"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - quickcart_network

  # Redis (OPTIONAL - comment out if you don't want to use Redis)
  # System will automatically use in-memory storage if Redis is unavailable
  # redis:
  #   image: redis:7-alpine
  #   container_name: quickcart_redis
  #   restart: unless-stopped
  #   command: redis-server --requirepass redis123
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
  #     interval: 5s
  #     timeout: 3s
  #     retries: 5
  #   networks:
  #     - quickcart_network

  # QuickCart Bot Application
  app:
    build: .
    container_name: quickcart_app
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - ./src:/app/src
      - ./migrations:/app/migrations
    depends_on:
      db:
        condition: service_healthy
      # redis:
      #   condition: service_healthy
    networks:
      - quickcart_network
    command: >
      sh -c "
        echo 'ðŸ”„ Waiting for database...' &&
        sleep 5 &&
        echo 'ðŸ”„ Running database migrations...' &&
        alembic upgrade head &&
        echo 'âœ… Starting QuickCart Bot...' &&
        python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
      "

volumes:
  postgres_data:
    name: quickcart_postgres_data
  redis_data:
    name: quickcart_redis_data

networks:
  quickcart_network:
    name: quickcart_network
    driver: bridge
